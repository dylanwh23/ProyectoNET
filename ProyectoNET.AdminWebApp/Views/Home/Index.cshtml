
@{
    ViewData["Title"] = "Panel de Administrador - Carreras";
}
@{
    var apiUrl = ViewData["ApiUrl"];
}

<script>
    const API_CARRERAS = '@apiUrl'; // ← se usa desde appsettings.json
    const API_USUARIOS = "https://localhost:7188"; // tu API de usuarios

    console.log("API Carreras:", API_CARRERAS);
</script>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .main-content {
            padding: 30px;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }

        .btn-action {
            margin: 0 5px;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-active {
            background-color: #28a745;
            color: white;
        }

        .status-pending {
            background-color: #ffc107;
            color: #000;
        }

        .status-finished {
            background-color: #6c757d;
            color: white;
        }

        .table-hover tbody tr:hover {
            background-color: #f1f3f5;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s;
        }

            .nav-link:hover, .nav-link.active {
                color: white;
                background-color: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
            }

        .punto-control-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .corredor-item {
            background: #e9ecef;
            padding: 8px 12px;
            margin: 5px;
            border-radius: 20px;
            display: inline-block;
        }

        #loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-4">
                <h3 class="mb-4"><i class="fas fa-flag-checkered"></i> RaceAdmin</h3>
                <ul class="nav flex-column">
                    <li class="nav-item mb-2">
                        <a class="nav-link active" href="#"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="#"><i class="fas fa-flag me-2"></i> Carreras</a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="#"><i class="fas fa-users me-2"></i> Participantes</a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="#"><i class="fas fa-trophy me-2"></i> Resultados</a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="#"><i class="fas fa-cog me-2"></i> Configuración</a>
                    </li>
                </ul>
                <hr class="my-4" style="border-color: rgba(255,255,255,0.3);">
                <div class="mt-auto">
                    <a class="nav-link" href="#"><i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión</a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-flag-checkered me-2"></i> Gestión de Carreras</h2>
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#modalCrearCarrera">
                        <i class="fas fa-plus me-2"></i> Crear Carrera
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalIniciarCarrera">
                        <i class="fas fa-play me-2"></i> Iniciar Carrera
                    </button>
                </div>

                <!-- Estadísticas -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" id="totalCarreras">0</h3>
                                <p class="text-muted mb-0">Carreras Totales</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-success" id="carrerasActivas">0</h3>
                                <p class="text-muted mb-0">En Curso</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-warning" id="carrerasPendientes">0</h3>
                                <p class="text-muted mb-0">Pendientes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-secondary" id="carrerasFinalizadas">0</h3>
                                <p class="text-muted mb-0">Finalizadas</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Carreras -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i> Lista de Carreras</h5>
                        <button class="btn btn-light btn-sm" onclick="cargarCarreras()">
                            <i class="fas fa-sync-alt me-1"></i> Actualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Distancia</th>
                                        <th>Participantes</th>
                                        <th>Puntos de Control</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaCarreras">
                                    <tr>
                                        <td colspan="7" class="text-center">Cargando carreras...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Crear Carrera -->
    <div class="modal fade" id="modalCrearCarrera" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i> Crear Nueva Carrera</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCrearCarrera" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nombreCarrera" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción *</label>
                            <textarea class="form-control" id="descripcionCarrera" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ubicación *</label>
                            <input type="text" class="form-control" id="ubicacionCarrera" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha de Inicio *</label>
                            <input type="datetime-local" class="form-control" id="fechaInicioCarrera" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Costo de Inscripción</label>
                            <input type="number" class="form-control" id="costoCarrera" placeholder="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Máximo de Participantes</label>
                            <input type="number" class="form-control" id="maxParticipantes" placeholder="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Imagen (opcional)</label>
                            <input type="file" class="form-control" id="imagenCarrera" accept="image/*">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-success" onclick="crearCarrera()">
                        <i class="fas fa-check me-2"></i> Crear Carrera
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal Detalle Carrera -->
    <div class="modal fade" id="modalDetalleCarrera" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i> Detalle de Carrera</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalleCarreraBody">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://localhost:7252';
        let corredores = [];
        let puntosControl = [];

        // Función para mostrar/ocultar loading
        function toggleLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Función para mostrar alertas
        function mostrarAlerta(mensaje, tipo = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Agregar corredor
        function agregarCorredor() {
            const input = document.getElementById('inputCorredor');
            const id = parseInt(input.value);

            if (isNaN(id) || id <= 0) {
                mostrarAlerta('Por favor ingrese un ID válido', 'warning');
                return;
            }

            if (corredores.includes(id)) {
                mostrarAlerta('Este corredor ya fue agregado', 'warning');
                return;
            }

            corredores.push(id);
            input.value = '';
            actualizarListaCorredores();
            actualizarJsonPreview();
        }

        // Actualizar lista de corredores
        function actualizarListaCorredores() {
            const lista = document.getElementById('listaCorredores');
            if (corredores.length === 0) {
                lista.innerHTML = '<small class="text-muted">No hay corredores agregados</small>';
                return;
            }

            lista.innerHTML = corredores.map(id => `
                <span class="corredor-item">
                    Corredor #${id}
                    <i class="fas fa-times ms-2" style="cursor: pointer;" onclick="eliminarCorredor(${id})"></i>
                </span>
            `).join('');
        }

        // Eliminar corredor
        function eliminarCorredor(id) {
            corredores = corredores.filter(c => c !== id);
            actualizarListaCorredores();
            actualizarJsonPreview();
        }

        // Agregar punto de control
        function agregarPuntoControl() {
            const inputId = document.getElementById('inputIdPunto');
            const inputKm = document.getElementById('inputKm');

            const id = parseInt(inputId.value);
            const km = parseFloat(inputKm.value);

            if (isNaN(id) || id <= 0 || isNaN(km) || km < 0) {
                mostrarAlerta('Por favor ingrese valores válidos', 'warning');
                return;
            }

            if (puntosControl.some(p => p.idPuntoDeControl === id)) {
                mostrarAlerta('Este punto de control ya existe', 'warning');
                return;
            }

            puntosControl.push({ idPuntoDeControl: id, km: km });
            puntosControl.sort((a, b) => a.km - b.km);

            inputId.value = '';
            inputKm.value = '';
            actualizarListaPuntosControl();
            actualizarJsonPreview();
        }

        // Actualizar lista de puntos de control
        function actualizarListaPuntosControl() {
            const lista = document.getElementById('listaPuntosControl');
            if (puntosControl.length === 0) {
                lista.innerHTML = '<small class="text-muted">No hay puntos de control agregados</small>';
                return;
            }

            lista.innerHTML = puntosControl.map(punto => `
                <div class="punto-control-item">
                    <span><strong>Punto #${punto.idPuntoDeControl}</strong> - ${punto.km} km</span>
                    <i class="fas fa-trash text-danger" style="cursor: pointer;" onclick="eliminarPuntoControl(${punto.idPuntoDeControl})"></i>
                </div>
            `).join('');
        }

        // Eliminar punto de control
        function eliminarPuntoControl(id) {
            puntosControl = puntosControl.filter(p => p.idPuntoDeControl !== id);
            actualizarListaPuntosControl();
            actualizarJsonPreview();
        }

        // Actualizar preview del JSON
        function actualizarJsonPreview() {
            const idCarrera = parseInt(document.getElementById('idCarrera').value) || 0;
            const json = {
                idCarrera: idCarrera,
                idCorredores: corredores,
                totalPuntosDeControl: puntosControl
            };
            document.getElementById('jsonPreview').textContent = JSON.stringify(json, null, 2);
        }

        // Iniciar carrera
                async function iniciarCarrera() {
            const idCarrera = parseInt(document.getElementById('idCarrera').value);

            if (isNaN(idCarrera) || idCarrera <= 0) {
                mostrarAlerta('Por favor ingrese un ID de carrera válido', 'danger');
                return;
            }

            if (puntosControl.length === 0) {
                mostrarAlerta('Debe agregar al menos un punto de control', 'danger');
                return;
            }

            toggleLoading(true);

            try {
                // 1️⃣ Obtener los corredores inscriptos desde la API de usuarios
                const respUsuarios = await fetch(`https://localhost:7188/api/Usuarios/inscriptos/${idCarrera}`);
                if (!respUsuarios.ok) {
                    throw new Error('No se pudo obtener la lista de usuarios inscriptos');
                }

                const usuarios = await respUsuarios.json();
                if (!usuarios || usuarios.length === 0) {
                    mostrarAlerta('No hay usuarios inscriptos para esta carrera', 'warning');
                    toggleLoading(false);
                    return;
                }

                // 2️⃣ Preparar datos para iniciar la carrera
                const data = {
                    idCarrera: idCarrera,
                    idCorredores: usuarios.map(u => u.id || u.idUsuario || u.idCorredor), // ajusta según tu modelo
                    totalPuntosDeControl: puntosControl
                };

                // 3️⃣ Enviar al endpoint de iniciar carrera
                const response = await fetch(`${API_URL}/api/Carreras/iniciar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    mostrarAlerta('¡Carrera iniciada exitosamente!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modalIniciarCarrera')).hide();
                    limpiarFormulario();
                    cargarCarreras();
                } else {
                    const error = await response.text();
                    mostrarAlerta(`Error al iniciar carrera: ${error}`, 'danger');
                }
            } catch (error) {
                console.error(error);
                mostrarAlerta('Error de conexión con la API', 'danger');
            } finally {
                toggleLoading(false);
            }
        }



        // Limpiar formulario
        function limpiarFormulario() {
            document.getElementById('idCarrera').value = '';
            corredores = [];
            puntosControl = [];
            actualizarListaCorredores();
            actualizarListaPuntosControl();
            actualizarJsonPreview();
        }

        // Cargar carreras desde la API
        async function cargarCarreras() {
            toggleLoading(true);
            try {
                const response = await fetch(`${API_URL}/api/Carreras`);
                const carreras = await response.json();

                const tbody = document.getElementById('tablaCarreras');

                if (!carreras || carreras.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay carreras registradas</td></tr>';
                    return;
                }

                tbody.innerHTML = carreras.map(carrera => `
                    <tr>
                        <td>#${carrera.id || carrera.idCarrera || '-'}</td>
                        <td>${carrera.nombre || 'Sin nombre'}</td>
                        <td>${carrera.distancia || '-'} km</td>
                        <td>${carrera.totalCorredores || carrera.corredores?.length || 0}</td>
                        <td>${carrera.totalPuntosControl || carrera.puntosControl?.length || 0}</td>
                        <td><span class="status-badge ${getEstadoClass(carrera.estado)}">${carrera.estado || 'Pendiente'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info btn-action" onclick="verDetalle(${carrera.id || carrera.idCarrera})" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="eliminarCarrera(${carrera.id || carrera.idCarrera})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Actualizar estadísticas
                actualizarEstadisticas(carreras);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('tablaCarreras').innerHTML =
                    '<tr><td colspan="7" class="text-center text-danger">Error al cargar las carreras</td></tr>';
            } finally {
                toggleLoading(false);
            }
        }

        // Obtener clase de estado
        function getEstadoClass(estado) {
            if (!estado) return 'status-pending';
            estado = estado.toLowerCase();
            if (estado.includes('activ') || estado.includes('curso')) return 'status-active';
            if (estado.includes('finaliz') || estado.includes('terminad')) return 'status-finished';
            return 'status-pending';
        }

        // Actualizar estadísticas
        function actualizarEstadisticas(carreras) {
            document.getElementById('totalCarreras').textContent = carreras.length;
            document.getElementById('carrerasActivas').textContent =
                carreras.filter(c => c.estado?.toLowerCase().includes('activ')).length;
            document.getElementById('carrerasPendientes').textContent =
                carreras.filter(c => !c.estado || c.estado?.toLowerCase().includes('pendiente')).length;
            document.getElementById('carrerasFinalizadas').textContent =
                carreras.filter(c => c.estado?.toLowerCase().includes('finaliz')).length;
        }

        // Ver detalle de carrera
        async function verDetalle(id) {
            toggleLoading(true);
            try {
                const response = await fetch(`${API_URL}/api/Carreras/${id}`);
                const carrera = await response.json();

                const modalBody = document.getElementById('detalleCarreraBody');
                modalBody.innerHTML = `
                    <div class="mb-3">
                        <h6>Información General</h6>
                        <p><strong>ID:</strong> ${carrera.id || carrera.idCarrera}</p>
                        <p><strong>Nombre:</strong> ${carrera.nombre || 'N/A'}</p>
                        <p><strong>Estado:</strong> <span class="status-badge ${getEstadoClass(carrera.estado)}">${carrera.estado || 'Pendiente'}</span></p>
                    </div>
                    <div class="mb-3">
                        <h6>Corredores (${carrera.corredores?.length || 0})</h6>
                        <div>${carrera.corredores?.map(c => `<span class="corredor-item">Corredor #${c}</span>`).join(' ') || 'No hay corredores'}</div>
                    </div>
                    <div class="mb-3">
                        <h6>Puntos de Control (${carrera.puntosControl?.length || 0})</h6>
                        ${carrera.puntosControl?.map(p => `<div class="punto-control-item"><span>Punto #${p.id} - ${p.km} km</span></div>`).join('') || 'No hay puntos de control'}
                    </div>
                `;

                new bootstrap.Modal(document.getElementById('modalDetalleCarrera')).show();
            } catch (error) {
                mostrarAlerta('Error al cargar el detalle de la carrera', 'danger');
            } finally {
                toggleLoading(false);
            }
        }

        // Eliminar carrera
        async function eliminarCarrera(id) {
            if (!confirm('¿Está seguro de que desea eliminar esta carrera?')) return;

            toggleLoading(true);
            try {
                const response = await fetch(`${API_URL}/api/Carreras/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    mostrarAlerta('Carrera eliminada exitosamente', 'success');
                    cargarCarreras();
                } else {
                    mostrarAlerta('Error al eliminar la carrera', 'danger');
                }
            } catch (error) {
                mostrarAlerta('Error de conexión con la API', 'danger');
            } finally {
                toggleLoading(false);
            }
        }


        async function crearCarrera() {
            const nombre = document.getElementById('nombreCarrera').value.trim();
            const descripcion = document.getElementById('descripcionCarrera').value.trim();
            const ubicacion = document.getElementById('ubicacionCarrera').value.trim();
            const fechaInicioLocal = document.getElementById('fechaInicioCarrera').value;
            const costoInscripcion = parseFloat(document.getElementById('costoCarrera').value);
            const cantidadMaximaParticipantes = parseInt(document.getElementById('maxParticipantes').value);
            const imagen = document.getElementById('imagenCarrera').files[0];

            if (!nombre || !descripcion || !ubicacion || !fechaInicioLocal) {
                mostrarAlerta('Complete todos los campos obligatorios', 'danger');
                return;
            }

            // 🕒 Convertir fecha local a UTC ISO 8601
            const fechaLocal = new Date(fechaInicioLocal);
            const fechaUTC = new Date(fechaLocal.getTime() - fechaLocal.getTimezoneOffset() * 60000).toISOString();

            toggleLoading(true);

            try {
                // 1️⃣ Crear la carrera
                const response = await fetch(`${API_CARRERAS}/api/Carreras`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nombre,
                        descripcion,
                        ubicacion,
                        fechaInicio: fechaUTC,
                        costoInscripcion: isNaN(costoInscripcion) ? 0 : costoInscripcion,
                        cantidadMaximaParticipantes: isNaN(cantidadMaximaParticipantes) ? 0 : cantidadMaximaParticipantes
                    })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || "Error al crear la carrera");
                }

                const carrera = await response.json();

                // 2️⃣ Subir imagen si existe
                if (imagen && carrera.id) {
                    const formData = new FormData();
                    formData.append('imagen', imagen);

                    const respImg = await fetch(`${API_CARRERAS}/api/Carreras/${carrera.id}/imagen`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!respImg.ok) throw new Error("Error al subir la imagen");
                }

                       mostrarAlerta('Carrera creada exitosamente ✅', 'success');

        // Cerrar el modal correctamente
        const modalEl = document.getElementById('modalCrearCarrera');
        const modalInstance = bootstrap.Modal.getInstance(modalEl) || bootstrap.Modal.getOrCreateInstance(modalEl);
        modalInstance.hide();

        // 🔥 Asegurar eliminación del backdrop después del cierre
        setTimeout(() => {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(b => b.remove());
        }, 500);

        // Limpiar formulario y recargar lista
        document.getElementById('formCrearCarrera').reset();
        cargarCarreras();


            } catch (error) {
                console.error(error);
                mostrarAlerta('No se pudo crear la carrera ❌', 'danger');
            } finally {
                toggleLoading(false);
            }
        }



        document.addEventListener('DOMContentLoaded', () => {

            const loadingDiv = document.getElementById('loading');
            if (!loadingDiv) {
                console.warn('⚠️ No se encontró el div#loading en el DOM');
            }

            function toggleLoading(show) {
                if (loadingDiv)
                    loadingDiv.style.display = show ? 'block' : 'none';
            }

            function mostrarAlerta(mensaje, tipo = 'success') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
                alertDiv.style.zIndex = '9999';
                alertDiv.innerHTML = `
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                setTimeout(() => {
                    alertDiv.remove();
                    toggleLoading(false); // ✅ siempre desbloquear al cerrar alerta
                }, 4000);
            }

            // Evita errores globales que dejen la UI bloqueada
            window.addEventListener('unhandledrejection', event => {
                console.error('Unhandled Promise rejection:', event.reason);
                toggleLoading(false);
            });

            window.addEventListener('error', event => {
                console.error('Global JS error:', event.error || event.message);
                toggleLoading(false);
            });

            // 🔧 ejemplo de uso si lo tenías antes:
            // document.getElementById('btnCrearCarrera').addEventListener('click', crearCarrera);

        });
    </script>
</body>
</html>